<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Max-P Regions — max_p_regions • spopt</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Max-P Regions — max_p_regions"><meta name="description" content="Perform Max-P regionalization to maximize the number of spatially contiguous
regions such that each region satisfies a minimum threshold constraint on a
specified attribute. This is useful for creating regions that meet minimum
population or sample size requirements."><meta property="og:description" content="Perform Max-P regionalization to maximize the number of spatially contiguous
regions such that each region satisfies a minimum threshold constraint on a
specified attribute. This is useful for creating regions that meet minimum
population or sample size requirements."><meta property="og:image" content="https://walker-data.com/spopt/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-#1e3a5f" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spopt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/regionalization.html">Regionalization</a></li>
    <li><a class="dropdown-item" href="../articles/facility-location.html">Facility Location</a></li>
    <li><a class="dropdown-item" href="../articles/huff-model.html">Huff Model</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/travel-time-matrices.html">Travel-Time Cost Matrices</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/kylewalker/spopt-r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Max-P Regions</h1>
      <small class="dont-index">Source: <a href="https://github.com/kylewalker/spopt-r/blob/HEAD/R/region_max_p.R" class="external-link"><code>R/region_max_p.R</code></a></small>
      <div class="d-none name"><code>max_p_regions.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Perform Max-P regionalization to maximize the number of spatially contiguous
regions such that each region satisfies a minimum threshold constraint on a
specified attribute. This is useful for creating regions that meet minimum
population or sample size requirements.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">max_p_regions</span><span class="op">(</span></span>
<span>  <span class="va">data</span>,</span>
<span>  attrs <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">threshold_var</span>,</span>
<span>  <span class="va">threshold</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"queen"</span>,</span>
<span>  bridge_islands <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  compact <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  compact_weight <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  n_iterations <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  n_sa_iterations <span class="op">=</span> <span class="fl">100L</span>,</span>
<span>  cooling_rate <span class="op">=</span> <span class="fl">0.99</span>,</span>
<span>  tabu_length <span class="op">=</span> <span class="fl">10L</span>,</span>
<span>  scale <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>An sf object with polygon or point geometries.</p></dd>


<dt id="arg-attrs">attrs<a class="anchor" aria-label="anchor" href="#arg-attrs"></a></dt>
<dd><p>Character vector of column names to use for computing
within-region dissimilarity (e.g., <code>c("var1", "var2")</code>). If NULL,
uses all numeric columns.</p></dd>


<dt id="arg-threshold-var">threshold_var<a class="anchor" aria-label="anchor" href="#arg-threshold-var"></a></dt>
<dd><p>Character. Name of the column containing the threshold
variable (e.g., population, income). Each region must have a sum of this
variable &gt;= <code>threshold</code>.</p></dd>


<dt id="arg-threshold">threshold<a class="anchor" aria-label="anchor" href="#arg-threshold"></a></dt>
<dd><p>Numeric. Minimum sum of <code>threshold_var</code> required per region.</p></dd>


<dt id="arg-weights">weights<a class="anchor" aria-label="anchor" href="#arg-weights"></a></dt>
<dd><p>Spatial weights specification. Can be:</p><ul><li><p><code>"queen"</code> (default): Polygons sharing any boundary point are neighbors</p></li>
<li><p><code>"rook"</code>: Polygons sharing an edge are neighbors</p></li>
<li><p>An <code>nb</code> object from spdep or created with <code><a href="sp_weights.html">sp_weights()</a></code></p></li>
<li><p>A list for other weight types: <code>list(type = "knn", k = 6)</code> for
k-nearest neighbors, or <code>list(type = "distance", d = 5000)</code> for
distance-based weights</p></li>
</ul><p>KNN weights guarantee connectivity (no islands), which can be useful
for datasets with disconnected polygons.</p></dd>


<dt id="arg-bridge-islands">bridge_islands<a class="anchor" aria-label="anchor" href="#arg-bridge-islands"></a></dt>
<dd><p>Logical. If TRUE, automatically connect disconnected
components (e.g., islands) using nearest-neighbor edges. If FALSE (default),
the function will error when the spatial weights graph is disconnected.
This is useful for datasets like LA County with Catalina Islands, or
archipelago data where physical adjacency doesn't exist but regionalization
is still desired.</p></dd>


<dt id="arg-compact">compact<a class="anchor" aria-label="anchor" href="#arg-compact"></a></dt>
<dd><p>Logical. If TRUE, optimize for region compactness in addition
to attribute homogeneity. Compact regions have more regular shapes, which
is useful for sales territories, patrol areas, and electoral districts.
Default is FALSE.</p></dd>


<dt id="arg-compact-weight">compact_weight<a class="anchor" aria-label="anchor" href="#arg-compact-weight"></a></dt>
<dd><p>Numeric between 0 and 1. Weight for compactness vs
attribute homogeneity when <code>compact = TRUE</code>. Higher values prioritize
compact shapes over attribute similarity. Default is 0.5.</p></dd>


<dt id="arg-n-iterations">n_iterations<a class="anchor" aria-label="anchor" href="#arg-n-iterations"></a></dt>
<dd><p>Integer. Number of construction phase iterations (default 100).
Higher values explore more random starting solutions.</p></dd>


<dt id="arg-n-sa-iterations">n_sa_iterations<a class="anchor" aria-label="anchor" href="#arg-n-sa-iterations"></a></dt>
<dd><p>Integer. Number of simulated annealing iterations (default 100).
Set to 0 to skip the SA refinement phase.</p></dd>


<dt id="arg-cooling-rate">cooling_rate<a class="anchor" aria-label="anchor" href="#arg-cooling-rate"></a></dt>
<dd><p>Numeric. SA cooling rate between 0 and 1 (default 0.99).
Smaller values cool faster, larger values allow more exploration.</p></dd>


<dt id="arg-tabu-length">tabu_length<a class="anchor" aria-label="anchor" href="#arg-tabu-length"></a></dt>
<dd><p>Integer. Length of tabu list for SA phase (default 10).</p></dd>


<dt id="arg-scale">scale<a class="anchor" aria-label="anchor" href="#arg-scale"></a></dt>
<dd><p>Logical. If TRUE (default), standardize attributes before
computing dissimilarity.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>Optional integer for reproducibility.</p></dd>


<dt id="arg-verbose">verbose<a class="anchor" aria-label="anchor" href="#arg-verbose"></a></dt>
<dd><p>Logical. Print progress messages.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An sf object with a <code>.region</code> column containing region assignments.
Metadata is stored in the "spopt" attribute, including:</p><ul><li><p>algorithm: "max_p"</p></li>
<li><p>n_regions: Number of regions created (the "p" in max-p)</p></li>
<li><p>objective: Total within-region sum of squared deviations</p></li>
<li><p>threshold_var: Name of threshold variable</p></li>
<li><p>threshold: Threshold value used</p></li>
<li><p>solve_time: Time to solve in seconds</p></li>
<li><p>mean_compactness: Mean Polsby-Popper compactness (if <code>compact = TRUE</code>)</p></li>
<li><p>region_compactness: Per-region compactness scores (if <code>compact = TRUE</code>)</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The Max-P algorithm (Duque, Anselin &amp; Rey, 2012; Wei, Rey &amp; Knaap, 2021)
solves the problem of aggregating n geographic areas into the maximum number
of homogeneous regions while ensuring:</p><ol><li><p>Each region is spatially contiguous (connected)</p></li>
<li><p>Each region satisfies a minimum threshold on a specified attribute</p></li>
</ol><p>The algorithm has two phases:</p><ol><li><p>Construction phase: Builds feasible solutions via randomized greedy
region growing. Multiple random starts are explored in parallel.</p></li>
<li><p>Simulated annealing phase: Refines solutions by moving border areas
between regions to minimize within-region dissimilarity while respecting
constraints.</p></li>
</ol><p>When <code>compact = TRUE</code>, the algorithm additionally optimizes for compact region
shapes based on Feng, Rey, &amp; Wei (2022). Compact regions:</p><ul><li><p>Minimize travel time within regions (useful for service territories)</p></li>
<li><p>Reduce gerrymandering potential (electoral districts)</p></li>
<li><p>Often result in finding MORE regions due to efficient space usage</p></li>
</ul><p><strong>Compactness metric</strong>: This implementation uses a centroid dispersion
measure during optimization, rather than the Normalized Moment of Inertia (NMI)
described in Feng et al. (2022). This design choice provides two advantages:</p><ol><li><p><strong>Point-based regionalization</strong>: The algorithm works with both
polygon and point geometries. For point data, use KNN or distance-based
weights (e.g., <code>weights = list(type = "knn", k = 6)</code>).</p></li>
<li><p><strong>Computational efficiency</strong>: Centroid dispersion is O(n) per
region versus O(v) for NMI where v = total polygon vertices.</p></li>
</ol><p>For polygon data, centroids are computed via <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">sf::st_centroid()</a></code>. Users should
be aware that centroid-based compactness may be less accurate for highly
irregular shapes or large, sparsely-populated areas where the centroid poorly
represents the polygon's spatial extent.</p>
<p>The reported <code>mean_compactness</code> and <code>region_compactness</code> in results use
Polsby-Popper (4<em>pi</em>A/P^2), a standard geometric compactness measure for
polygons. For point data, these metrics are not computed.</p>
<p>This implementation is optimized for speed using:</p><ul><li><p>Parallel construction with early termination</p></li>
<li><p>Efficient articulation point detection for move eligibility</p></li>
<li><p>Incremental threshold tracking</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Duque, J. C., Anselin, L., &amp; Rey, S. J. (2012). The max-p-regions problem.
Journal of Regional Science, 52(3), 397-419.</p>
<p>Wei, R., Rey, S., &amp; Knaap, E. (2021). Efficient regionalization for spatially
explicit neighborhood delineation. International Journal of Geographical
Information Science, 35(1), 135-151. <a href="https://doi.org/10.1080/13658816.2020.1759806" class="external-link">doi:10.1080/13658816.2020.1759806</a></p>
<p>Feng, X., Rey, S., &amp; Wei, R. (2022). The max-p-compact-regions problem.
Transactions in GIS, 26, 717-734. <a href="https://doi.org/10.1111/tgis.12874" class="external-link">doi:10.1111/tgis.12874</a></p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shape/nc.shp"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create regions where each has at least 100,000 in BIR74</span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">max_p_regions</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">nc</span>,</span></span>
<span class="r-in"><span>  attrs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SID74"</span>, <span class="st">"SID79"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  threshold_var <span class="op">=</span> <span class="st">"BIR74"</span>,</span></span>
<span class="r-in"><span>  threshold <span class="op">=</span> <span class="fl">100000</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check number of regions created</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">result</span>, <span class="st">"spopt"</span><span class="op">)</span><span class="op">$</span><span class="va">n_regions</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># With compactness optimization (for sales territories)</span></span></span>
<span class="r-in"><span><span class="va">result_compact</span> <span class="op">&lt;-</span> <span class="fu">max_p_regions</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">nc</span>,</span></span>
<span class="r-in"><span>  attrs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SID74"</span>, <span class="st">"SID79"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  threshold_var <span class="op">=</span> <span class="st">"BIR74"</span>,</span></span>
<span class="r-in"><span>  threshold <span class="op">=</span> <span class="fl">100000</span>,</span></span>
<span class="r-in"><span>  compact <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  compact_weight <span class="op">=</span> <span class="fl">0.5</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check compactness</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">result_compact</span>, <span class="st">"spopt"</span><span class="op">)</span><span class="op">$</span><span class="va">mean_compactness</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Plot results</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">[</span><span class="st">".region"</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Point-based regionalization (e.g., store locations, sensor networks)</span></span></span>
<span class="r-in"><span><span class="co"># Use KNN weights since points don't have polygon contiguity</span></span></span>
<span class="r-in"><span><span class="va">points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">200</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  customers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html" class="external-link">rpois</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">100</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  avg_income <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fl">50000</span>, <span class="fl">15000</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result_points</span> <span class="op">&lt;-</span> <span class="fu">max_p_regions</span><span class="op">(</span></span></span>
<span class="r-in"><span>  <span class="va">points</span>,</span></span>
<span class="r-in"><span>  attrs <span class="op">=</span> <span class="st">"avg_income"</span>,</span></span>
<span class="r-in"><span>  threshold_var <span class="op">=</span> <span class="st">"customers"</span>,</span></span>
<span class="r-in"><span>  threshold <span class="op">=</span> <span class="fl">500</span>,</span></span>
<span class="r-in"><span>  weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"knn"</span>, k <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  compact <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kyle Walker.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer></div>





  </body></html>

