name: Build Rust Library

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install LLVM
        run: |
          choco install llvm -y --force
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

      - name: Install Rust (GNU toolchain)
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-gnu

      - name: Set default toolchain to GNU
        run: rustup default stable-x86_64-pc-windows-gnu

      - name: Build Rust library
        working-directory: src/rust
        run: |
          cargo build --release --target x86_64-pc-windows-gnu
        env:
          LIBCLANG_PATH: C:\Program Files\LLVM\bin

      - name: Prepare artifact
        run: |
          mkdir artifact
          copy src\rust\target\x86_64-pc-windows-gnu\release\libspopt.a artifact\libspopt-x86_64-pc-windows-gnu.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libspopt-x86_64-pc-windows-gnu
          path: artifact/libspopt-x86_64-pc-windows-gnu.a

  build-macos-intel:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Build Rust library (cross-compile for Intel)
        working-directory: src/rust
        run: cargo build --release --target x86_64-apple-darwin

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp src/rust/target/x86_64-apple-darwin/release/libspopt.a artifact/libspopt-x86_64-apple-darwin.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libspopt-x86_64-apple-darwin
          path: artifact/libspopt-x86_64-apple-darwin.a

  build-macos-arm:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust library
        working-directory: src/rust
        run: cargo build --release

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp src/rust/target/release/libspopt.a artifact/libspopt-aarch64-apple-darwin.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libspopt-aarch64-apple-darwin
          path: artifact/libspopt-aarch64-apple-darwin.a

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libclang-dev cmake

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Rust library
        working-directory: src/rust
        run: cargo build --release

      - name: Prepare artifact
        run: |
          mkdir -p artifact
          cp src/rust/target/release/libspopt.a artifact/libspopt-x86_64-unknown-linux-gnu.a

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libspopt-x86_64-unknown-linux-gnu
          path: artifact/libspopt-x86_64-unknown-linux-gnu.a

  create-release:
    needs: [build-windows, build-macos-intel, build-macos-arm, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version from DESCRIPTION
        id: version
        run: |
          VERSION=$(grep "^Version:" DESCRIPTION | sed 's/Version: //')
          echo "version=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect artifacts
        run: |
          mkdir -p release
          cp artifacts/libspopt-x86_64-pc-windows-gnu/libspopt-x86_64-pc-windows-gnu.a release/
          cp artifacts/libspopt-x86_64-apple-darwin/libspopt-x86_64-apple-darwin.a release/
          cp artifacts/libspopt-aarch64-apple-darwin/libspopt-aarch64-apple-darwin.a release/
          cp artifacts/libspopt-x86_64-unknown-linux-gnu/libspopt-x86_64-unknown-linux-gnu.a release/

      - name: Generate checksums and lib-sums.tsv
        run: |
          cd release
          sha256sum *.a > checksums.txt
          cat checksums.txt

          # Generate lib-sums.tsv for the package
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/walkerke/spopt-r/releases/download/${VERSION}"

          echo -e "target\tsha256\turl" > lib-sums.tsv

          for file in *.a; do
            sha=$(sha256sum "$file" | cut -d' ' -f1)
            target=$(echo "$file" | sed 's/libspopt-//' | sed 's/\.a$//')
            echo -e "${target}\t${sha}\t${BASE_URL}/${file}" >> lib-sums.tsv
          done

          cat lib-sums.tsv

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Library Build ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            release/libspopt-x86_64-pc-windows-gnu.a
            release/libspopt-x86_64-apple-darwin.a
            release/libspopt-aarch64-apple-darwin.a
            release/libspopt-x86_64-unknown-linux-gnu.a
            release/checksums.txt
            release/lib-sums.tsv
          body: |
            Pre-built Rust libraries for spopt.

            Download `lib-sums.tsv` and place in `tools/` directory to enable automatic binary downloads.
