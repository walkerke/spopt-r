#!/bin/sh

# Configure script for spopt
# Attempts to download pre-built Rust library when appropriate

export PATH="$PATH:$HOME/.cargo/bin"

# Environment variables
NOT_CRAN=${NOT_CRAN:-"false"}
LIB_BUILD=${LIBSPOPT_BUILD:-""}
MY_UNIVERSE=${MY_UNIVERSE:-""}

LIBNAME="libspopt.a"
LIB_DEFAULT_PATH="$(pwd)/tools/${LIBNAME}"
LIB_PATH=${LIBSPOPT_PATH:-${LIB_DEFAULT_PATH}}

check_cargo() {
  if [ ! "$(command -v cargo)" ]; then
    cat <<EOF
------------------------- [RUST NOT FOUND] -------------------------
The 'cargo' command was not found on the PATH. Please install Rust
from: https://www.rust-lang.org/tools/install

  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

Alternatively, install from your OS package manager:
  - Debian/Ubuntu: apt-get install cargo
  - Fedora/CentOS: dnf install cargo
  - macOS: brew install rustc
--------------------------------------------------------------------
EOF
    exit 1
  else
    cat <<EOF
--------------------------- [RUST FOUND] ---------------------------
$(cargo -V)
$(rustc -vV)
--------------------------------------------------------------------
EOF
  fi
}

detect_target() {
  if [ -n "${TARGET}" ]; then
    echo "${TARGET}"
  elif command -v rustc > /dev/null 2>&1; then
    rustc -vV | grep host | cut -d' ' -f2
  else
    # Fallback detection without rustc
    case "$(uname -s)-$(uname -m)" in
      Linux-x86_64)  echo "x86_64-unknown-linux-gnu" ;;
      Linux-aarch64) echo "aarch64-unknown-linux-gnu" ;;
      Darwin-x86_64) echo "x86_64-apple-darwin" ;;
      Darwin-arm64)  echo "aarch64-apple-darwin" ;;
      *)             echo "unknown" ;;
    esac
  fi
}

check_bin_lib() {
  # If NOT_CRAN=true and no explicit build flag, try pre-built
  if [ "${NOT_CRAN}" = "true" ] && [ -z "${LIB_BUILD}" ]; then
    LIB_BUILD="false"
  fi

  # On R-universe, try to download pre-built binary
  if [ -n "${MY_UNIVERSE}" ] && [ -z "${LIB_BUILD}" ]; then
    cat <<EOF
--------------------- [SETTING FOR R-UNIVERSE] ---------------------
Detected R-universe build <${MY_UNIVERSE}>.
Attempting to download pre-built binary.
--------------------------------------------------------------------
EOF
    LIB_BUILD="false"
  fi

  if [ "${LIB_BUILD}" = "false" ]; then
    if [ -f "tools/lib-sums.tsv" ] && [ ! -f "${LIB_PATH}" ]; then
      cat <<EOF
---------------- [TRY TO DOWNLOAD PRE-BUILT BINARY] ----------------
The library was not found at <${LIB_PATH}>.
Trying to download pre-built binary from GitHub releases...
--------------------------------------------------------------------
EOF
      "${R_HOME}/bin${R_ARCH_BIN}/Rscript" "tools/prep-lib.R" && echo "Done!" ||
        echo "Failed to download pre-built binary."
    fi

    if [ -f "${LIB_PATH}" ] && [ "${LIB_PATH}" != "${LIB_DEFAULT_PATH}" ]; then
      cat <<EOF
------------------------- [COPYING BINARY] -------------------------
Copying <${LIB_PATH}> to <${LIB_DEFAULT_PATH}>.
--------------------------------------------------------------------
EOF
      mkdir -p "$(dirname "${LIB_DEFAULT_PATH}")"
      cp "${LIB_PATH}" "${LIB_DEFAULT_PATH}" && echo "Done!" || echo "Failed to copy binary."
    fi

    if [ -f "${LIB_DEFAULT_PATH}" ]; then
      cat <<EOF
---------------------- [LIBRARY BINARY FOUND] ----------------------
The library was found at <${LIB_DEFAULT_PATH}>. No need to build.
--------------------------------------------------------------------
EOF
      # Create marker file and copy to expected location
      TARGET=$(detect_target)
      mkdir -p "src/rust/target/${TARGET}/release"
      cp "${LIB_DEFAULT_PATH}" "src/rust/target/${TARGET}/release/libspopt.a"
      touch "src/rust/target/${TARGET}/release/.prebuilt"
      exit 0
    fi

    cat <<EOF
-------------------- [LIBRARY BINARY NOT FOUND] --------------------
Pre-built binary not available. Will build from source.
--------------------------------------------------------------------
EOF
  fi
}

check_env() {
  cat <<EOF
--------------------- [ENVIRONMENT VARIABLES] ---------------------
NOT_CRAN = '${NOT_CRAN}'
LIBSPOPT_BUILD = '${LIB_BUILD}'
MY_UNIVERSE = '${MY_UNIVERSE}'
-------------------------------------------------------------------
EOF
}

# Main execution
check_env
check_bin_lib
check_cargo

exit 0
